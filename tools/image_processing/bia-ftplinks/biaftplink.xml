<tool id="bia_download" name="FTP Link for Bioimage Archive" version="@VERSION@+galaxy0" profile="22.05">
    <description>Download images (TIFF) from Bioimage Archive</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="aggressive">
<![CDATA[
    curl -s https://www.ebi.ac.uk/biostudies/api/v1/studies/$accession/info | jq -r .ftpLink >> ftpLink.txt &&
    wget -q -r -l 0 -i ftpLink.txt &&

    find . -type f -name "*.zip" | while read zip_file; do
        unzip -o "\$zip_file" -d "\$(dirname "\$zip_file")" &> /dev/null;
    done

]]>
    </command>
    <inputs>
        <param name="accession" type="text" label="The accession ID of BioImages-Core or BioStudies-JCB" help="for eg. S-BIAD570, S-JCBD-201309038"/>
        <param name="ftplink_output" type="boolean" label="Generate FTP links?" help="If set, a file containing FTP links associated with the accession will be generated." />
    </inputs>
    <outputs>
        <collection name="images" type="list" label="${tool.name} on ${on_string}: TIFF Images">
            <discover_datasets pattern="(?P&lt;designation&gt;.*)\.tif" format="tif,tiff" directory="ftp.ebi.ac.uk" recurse="true" />
        </collection>
        <data format="txt" name="ftplinks" from_work_dir="ftpLink.txt" label="${tool.name} on ${on_string}: FTP Links">
            <filter>ftplink_output</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs='1'>
            <param name="accession" value="S-BIAD961" />
            <param name="ftplink_output" value="False" />
            <output_collection name="images">
                <element name="Study_Component-4_mznanog_mCherry-AAT">
                    <assert_contents><has_size value="14092624" /></assert_contents>
                </element>
            </output_collection>
        </test>
        <test expect_num_outputs='2'>
            <param name="accession" value="S-JCBD-201309038" />
            <param name="ftplink_output" value="True" />
            <output_collection name="images">
                 <element name="JCB_STIL_serial">
                     <assert_contents><has_size value="7446240" /></assert_contents>
                </element>
                <element name="Sir_JCB_STIL_serial">
                     <assert_contents><has_size value="7436060" /></assert_contents>
                </element>
            </output_collection>
            <output name="ftplinks" ftype="txt" file="ftpLink.txt" lines_diff="0" />
        </test>
    </tests>
    <help>
<![CDATA[
        **What it does**
        This tool downloads images from the Bioimage Archive and optionally outputs FTP links associated with the input accession.
]]>
    </help>
    <expand macro="citations" />
</tool>
