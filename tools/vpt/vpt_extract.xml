<tool id="vpt_extract" name="Vizgen Post-processing Tool - Extract" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>Extract image patches</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p 'input/images' 'output/' &&
        #for $image in $input_images:
            ln -s '$image' 'input/images/${image.element_identifier}.${image.ext}' &&
        #end for
        ln -s '$input_micron_to_mosaic' 'input/micron_to_mosaic_pixel_transform.csv' &&
        vpt
            @COMMON_ARGS@
            extract-image-patch
            --input-images 'input/images/'
            --input-micron-to-mosaic 'input/micron_to_mosaic_pixel_transform.csv'
            --output-patch 'output/patch1.png'
            --center-x $center_x
            --center-y $center_y
            --size-x $size_x
            --size-y $size_y
            --input-z-index $input_z_index
            --red-stain-name $red_stain_name
            --green-stain-name $green_stain_name
            --blue-stain-name $blue_stain_name
            --normalization $normalization
    ]]></command>
    <inputs>
        <param argument="--input_images" type="data" format="tiff" multiple="true" label="MEROSCOPE tiff images"/>
        <param argument="--input_micron_to_mosaic" type="data" format="csv" label="Micron to mosaic mapping file"/>
        <param argument="--center-x" type="integer" label="X coordinate in micron space"/>
        <param argument="--center-y" type="integer" label="Y coordinate in micron space"/>
        <param argument="--size-x" type="integer" value="108" label="Width of the patch in micron space"/>
        <param argument="--size-y" type="integer" value="108" label="Height of the patch in micron space"/>
        <param argument="--input_z_index" type="integer" min="0" value="2" label="The Z plane of the mosaic tiff images to use for the patch"/>
        <param argument="--red-stain-name" type="text" value="" optional="true" label="The name of the stain that will be used for the red channel in images"/>
        <param argument="--green-stain-name" type="text" value="" optional="true" label="The name of the stain that will be used for the green channel in images"/>
        <param argument="--blue-stain-name" type="text" value="" optional="true" label="The name of the stain that will be used for the blue channel in images"/>
        <param name="normalization" type="select" label="Normalization method that will be used on each channel of the patch">
            <option value="default">default (min-max range normalization)</option>
            <option value="CLAHE">CLAHE (Contrast Limited Adaptive Histogram Equalization)</option>
        </param>
        <section name="advanced_output" title="Advanced output options">
            <param name="log" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Output log?"/>
        </section>
    </inputs>
    <outputs>
        <data name="patch_image" format="png" from_work_dir="output/patch1.png" label="${tool.name} on ${on_string}: Patched image"/>
        <data name="vpt_log" format="txt" from_work_dir="output/log" label="${tool.name} on ${on_string}: VPT log">
            <filter>advanced_output['log']</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="input_images" location="https://zenodo.org/records/15307539/files/mosaic_Cellbound1_z0.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound1_z1.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound1_z2.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound1_z3.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound1_z4.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound1_z5.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound1_z6.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound2_z0.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound2_z1.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound2_z2.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound2_z3.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound2_z4.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound2_z5.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound2_z6.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound3_z0.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound3_z1.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound3_z2.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound3_z3.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound3_z4.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound3_z5.tif,https://zenodo.org/records/15307539/files/mosaic_Cellbound3_z6.tif,https://zenodo.org/records/15307539/files/mosaic_DAPI_z0.tif,https://zenodo.org/records/15307539/files/mosaic_DAPI_z1.tif,https://zenodo.org/records/15307539/files/mosaic_DAPI_z2.tif,https://zenodo.org/records/15307539/files/mosaic_DAPI_z3.tif,https://zenodo.org/records/15307539/files/mosaic_DAPI_z4.tif,https://zenodo.org/records/15307539/files/mosaic_DAPI_z5.tif,https://zenodo.org/records/15307539/files/mosaic_DAPI_z6.tif,https://zenodo.org/records/15307539/files/mosaic_PolyT_z0.tif,https://zenodo.org/records/15307539/files/mosaic_PolyT_z1.tif,https://zenodo.org/records/15307539/files/mosaic_PolyT_z2.tif,https://zenodo.org/records/15307539/files/mosaic_PolyT_z3.tif,https://zenodo.org/records/15307539/files/mosaic_PolyT_z4.tif,https://zenodo.org/records/15307539/files/mosaic_PolyT_z5.tif,https://zenodo.org/records/15307539/files/mosaic_PolyT_z6.tif"/>
            <param name="input_micron_to_mosaic" location="https://zenodo.org/records/15307539/files/micron_to_mosaic_pixel_transform.csv"/>
            <param name="center_x" value="200"/>
            <param name="center_y" value="200"/>
            <param name="size_x" value="208"/>
            <param name="size_y" value="208"/>
            <param name="input_z_index" value="2"/>
            <param name="red_stain_name" value="Cellbound1"/>
            <param name="green_stain_name" value="Cellbound3"/>
            <param name="blue_stain_name" value="DAPI"/>
            <param name="normalization" value="CLAHE"/>
            <section name="advanced_output">
                <param name="log" value="true"/>
            </section>
            <output name="patch_image" location="https://zenodo.org/records/15307539/files/patch1.png" ftype="png" compare="image_diff"/>
            <output name="vpt_log">
                <assert_contents>
                    <has_text_matching expression="vpt 1.3.0"/>
                    <has_text_matching expression="vpt_plugin_cellpose2 1.0.1"/>
                    <has_text_matching expression="Extract image patch finished"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
The Vizgen Post-processing Tool (VPT) is a scalable and reproducible tool which enables users to reprocess and refine the single-cell results of MERSCOPE experiments.

The extract-image-patch tool extracts a patch from the mosaic image at the specified coordinates and size. The patch is saved as a PNG image. It can be used for manual segmentation or for training machine learning models.
    </help>
    <expand macro="citations" />
</tool>